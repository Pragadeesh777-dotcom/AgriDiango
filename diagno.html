<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Crop + Disease Auto-Detect</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
         :root {
            --bg: #f2fff6;
            --card: #fff;
            --accent: #117a14;
            --muted: #7a7a7a;
            --panel: #eafdea;
        }
        
        * {
            box-sizing: border-box
        }
        
        body {
            font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: linear-gradient(180deg, #f7fff7 0%, #f0fff6 100%);
            margin: 0;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        
        .container {
            width: 760px;
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 6px 22px rgba(20, 80, 30, .06);
            padding: 32px;
            border: 1px solid rgba(18, 120, 20, .03);
            position: relative;
        }
        
        .title {
            text-align: center;
            color: var(--accent);
            font-size: 28px;
            font-weight: 700;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-bottom: 18px;
        }
        
        .title img {
            width: 32px;
            height: 32px
        }
        /* Translator */
        
        .translator-container {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            background: #064420;
            padding: 6px 12px;
            border-radius: 20px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, .2);
        }
        
        .translator-container i {
            font-size: 1.1rem;
            color: #00e6e6;
            margin-right: 6px;
        }
        
        #google_translate_element {
            font-size: 0.85rem;
            color: white;
        }
        
        .goog-te-gadget {
            color: white !important;
        }
        
        .goog-te-combo {
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 0.85rem;
            border: none;
            outline: none;
        }
        
        .form-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 18px;
        }
        
        label {
            color: var(--muted);
            font-weight: 600
        }
        
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            min-width: 140px;
            background: white;
        }
        
        .uploader {
            display: flex;
            justify-content: center;
            margin-bottom: 14px
        }
        
        input[type=file] {
            display: block
        }
        
        .preview {
            display: flex;
            justify-content: center;
            margin: 18px 0
        }
        
        .preview img {
            width: 340px;
            height: 220px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .06);
            border: 6px solid rgba(255, 255, 255, .6);
        }
        
        .analyze-btn {
            display: flex;
            justify-content: center;
            margin: 10px 0 20px
        }
        
        button.primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 22px;
            font-weight: 700;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .result-panel {
            background: var(--panel);
            padding: 18px;
            border-radius: 10px;
            border: 1px solid rgba(0, 120, 20, .06);
            color: #0a3d10;
        }
        
        .result-line {
            margin: 6px 0;
            font-weight: 600
        }
        
        .small {
            font-weight: 400;
            color: #0b3d14
        }
        
        .hint {
            margin-top: 12px;
            color: #4c7945;
            font-size: 13px;
            text-align: center
        }
        
        .file-box {
            display: inline-block;
            padding: 12px 14px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background: white;
        }
        
        @media (max-width:800px) {
            body {
                padding: 20px
            }
            .container {
                width: 100%
            }
            .preview img {
                width: 95%;
                height: auto
            }
        }
    </style>
</head>

<body>
    <div class="container" role="main">

        <!-- Translator -->
        <div class="translator-container">
            <i class="fa fa-globe"></i>
            <div id="google_translate_element"></div>
        </div>

        <div class="title">
            <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23117a14' d='M12 2c1.1 0 2 .9 2 2 0 2-1 3-2 4-1-1-2-2-2-4 0-1.1.9-2 2-2zM5 11c.6-3 3.6-5 7-5s6.4 2 7 5c.2 1.2.2 2.4 0 3.6C18.6 21 12 22 12 22s-6.6-1-7-7.4c-.2-1.2-.2-2.4 0-3.6z'/></svg>"
                alt="sprout"> Crop Disease Detection (auto-crop)
        </div>

        <div class="form-row">
            <label for="plantSelect">Select Plant (optional):</label>
            <select id="plantSelect">
                <option value="">-- Let system decide --</option>
                <option>Rice</option><option>Wheat</option><option>Maize</option><option>Ragi</option><option>Mango</option>
                <option>Onion</option><option>Tomato</option><option>Potato</option><option>Carrot</option><option>Apple</option>
                <option>Banana</option><option>Papaya</option>
            </select>
        </div>

        <div class="uploader">
            <label class="file-box">
                Choose Image
                <input id="fileInput" type="file" accept="image/*">
            </label>
        </div>

        <div class="preview" aria-live="polite">
            <img id="previewImg" src="" alt="" style="display:none">
        </div>

        <div class="analyze-btn">
            <button id="analyzeBtn" class="primary">Analyze</button>
        </div>

        <div id="result" class="result-panel" style="display:none" aria-live="polite">
            <div class="result-line">Detected Plant: <span id="outPlant"></span></div>
            <div class="result-line">Status: <span id="outStatus"></span></div>
            <div class="result-line">Recommended Fertilizer/Treatment: <span id="outRec" class="small"></span></div>
            <div class="result-line">Confidence: <span id="outConf"></span></div>
            <div class="result-line small" id="userChoiceHint"></div>
        </div>

        <div class="hint">
            Tip: If you want a different plant than detected, select it from the dropdown (shown below as reference).
        </div>
    </div>

    <!-- Font Awesome for Globe Icon -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <!-- Google Translate -->
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,ta,hi,te,kn,ml,mr,bn',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE
            }, 'google_translate_element');
        }
    </script>
    <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <script>
        const fileInput = document.getElementById('fileInput');
        const previewImg = document.getElementById('previewImg');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const plantSelect = document.getElementById('plantSelect');
        const resultPanel = document.getElementById('result');
        const outPlant = document.getElementById('outPlant');
        const outStatus = document.getElementById('outStatus');
        const outRec = document.getElementById('outRec');
        const outConf = document.getElementById('outConf');
        const userChoiceHint = document.getElementById('userChoiceHint');

        let loadedImage = null;
        let lastImageData = null;

        fileInput.addEventListener('change', async(e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            previewImg.src = url;
            previewImg.style.display = 'block';
            previewImg.alt = file.name;
            loadedImage = {
                file,
                url
            };
            lastImageData = await getImageDataFromFile(file, 160, 120);
        });

        analyzeBtn.addEventListener('click', async() => {
            if (!loadedImage) {
                alert('Please choose an image first.');
                return;
            }
            let detectedCrop = detectCrop(loadedImage.file.name, lastImageData);
            const diseaseResult = pseudoDiseaseDetector(detectedCrop, lastImageData);
            outPlant.textContent = detectedCrop.toUpperCase();
            outStatus.textContent = `${diseaseResult.status} (${diseaseResult.scientificName})`;
            outRec.textContent = diseaseResult.recommendation;
            outConf.textContent = diseaseResult.confidence.toFixed(1) + '%';
            resultPanel.style.display = 'block';
            userChoiceHint.textContent = plantSelect.value ? `User selected (reference): ${plantSelect.value}` : '';
        });

        async function getImageDataFromFile(file, maxW = 200, maxH = 200) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
                    canvas.width = Math.max(1, Math.floor(img.width * ratio));
                    canvas.height = Math.max(1, Math.floor(img.height * ratio));
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    try {
                        resolve(ctx.getImageData(0, 0, canvas.width, canvas.height));
                    } catch (err) {
                        reject(err);
                    }
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        function detectCrop(filename = '', imgData = null) {
            const name = filename.toLowerCase();
            const crops = ['rice', 'wheat', 'ragi', 'maize', 'corn', 'mango', 'onion', 'tomato', 'potato', 'carrot', 'apple', 'banana', 'papaya'];
            for (let c of crops)
                if (name.includes(c)) return capitalize(c);
            if (!imgData) return 'Unknown';
            const avg = avgRGB(imgData);
            if (avg.g > avg.r + 20 && avg.g > avg.b + 15) return 'Rice';
            if (avg.r > avg.g + 18 && avg.b < 120) {
                const sat = Math.max(avg.r, avg.g, avg.b) - Math.min(avg.r, avg.g, avg.b);
                return sat > 55 ? 'Ragi' : 'Wheat';
            }
            if (avg.r > 200 && avg.g > 150 && avg.b < 100) return 'Mango';
            if (avg.r > 180 && avg.g > 180 && avg.b < 120) return 'Onion';
            if (avg.r > 200 && avg.g < 120 && avg.b < 120) return 'Tomato';
            if (avg.r > 150 && avg.g > 100 && avg.b > 80) return 'Potato';
            if (avg.r > 180 && avg.g > 120 && avg.b > 100) return 'Carrot';
            if (avg.r > 200 && avg.g > 200 && avg.b > 150) return 'Banana';
            if (avg.r > 180 && avg.g > 220 && avg.b > 120) return 'Papaya';
            return 'Maize';
        }

        function avgRGB(imageData) {
            const data = imageData.data;
            let r = 0,
                g = 0,
                b = 0,
                count = 0;
            for (let i = 0; i < data.length; i += 4) {
                r += data[i];
                g += data[i + 1];
                b += data[i + 2];
                count++;
            }
            return {
                r: Math.round(r / count),
                g: Math.round(g / count),
                b: Math.round(b / count)
            };
        }

        function pseudoDiseaseDetector(cropName, imageData) {
            let sum = 0;
            if (imageData && imageData.data) {
                const d = imageData.data;
                for (let i = 0; i < d.length; i += 83) sum = (sum + d[i] + d[i + 1] * 3 + d[i + 2] * 7) | 0;
            } else sum = Math.floor(Math.random() * 1000);
            const seed = Math.abs(sum) % 1000;

            const outcomes = {
                'Rice': [{
                    common: 'Healthy',
                    scientific: 'N/A'
                }, {
                    common: 'Blast',
                    scientific: 'Magnaporthe oryzae'
                }],
                'Wheat': [{
                    common: 'Healthy',
                    scientific: 'N/A'
                }, {
                    common: 'Rust',
                    scientific: 'Puccinia spp.'
                }],
                'Maize': [{
                    common: 'Healthy',
                    scientific: 'N/A'
                }, {
                    common: 'Gray Leaf Spot',
                    scientific: 'Cercospora zeae-maydis'
                }],
                'Ragi': [{
                    common: 'Healthy',
                    scientific: 'N/A'
                }, {
                    common: 'Smut',
                    scientific: 'Ustilago spp.'
                }],
                'Mango': [{
                    common: 'Healthy',
                    scientific: 'N/A'
                }, {
                    common: 'Anthracnose',
                    scientific: 'Colletotrichum gloeosporioides'
                }]
            };

            const recs = {
                'Rice': {
                    'Healthy': 'Balanced NPK + zinc sulfate',
                    'Blast': 'Resistant varieties + fungicide'
                },
                'Wheat': {
                    'Healthy': 'Balanced NPK',
                    'Rust': 'Resistant varieties + propiconazole'
                },
                'Maize': {
                    'Healthy': 'Balanced NPK',
                    'Gray Leaf Spot': 'Fungicide + crop rotation'
                },
                'Ragi': {
                    'Healthy': 'Balanced NPK',
                    'Smut': 'Seed treatment'
                },
                'Mango': {
                    'Healthy': 'Balanced NPK + pruning',
                    'Anthracnose': 'Fungicide + remove infected parts'
                }
            };

            const list = outcomes[cropName] || [{
                common: 'Healthy',
                scientific: 'N/A'
            }];
            const idx = seed % list.length;
            const disease = list[idx];
            const confidence = 60 + (seed % 41);
            const recommendation = (recs[cropName] && recs[cropName][disease.common]) || 'General good agronomic practices';

            return {
                status: disease.common,
                scientificName: disease.scientific,
                recommendation,
                confidence
            };
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    </script>
</body>

</html>